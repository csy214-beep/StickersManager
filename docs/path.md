# 🎯 Windows表情包管理器完整方案

## 一、项目概述

### 核心定位
一款轻量级、高效率的**Windows**桌面表情包管理工具，通过全局热键快速呼出，实现表情包的分类管理、快速检索和便捷使用。

### 设计理念
- **即用即走**：全局热键呼出，Esc隐藏，不干扰正常工作
- **本地优先**：所有数据存储在本地，隐私安全
- **性能优先**：懒加载、智能缓存保证流畅体验
- **直观操作**：点击高亮、双击复制的自然交互

## 二、功能规格详述

### 1. 表情库管理
- **库目录结构**：
  - 用户指定一个根目录作为表情总库
  - 每个子文件夹为一个表情分类（类别）
  - 分类文件夹内存储各种格式的表情图片文件
- **格式支持**：
    尽可能支持所有图片，忽略不支持的文件，如md,txt,html...
- **数据加载策略**：
  - 程序启动时扫描目录结构
  - 仅加载文件元信息，不加载图片数据
  - 损坏或无法识别的文件静默忽略并记录日志

### 2. 用户界面设计
- **窗口特性**：
  - 非置顶窗口，允许与其他窗口交互
  - 默认定位屏幕右上角，智能边界检测
  - 自适应不同屏幕分辨率和DPI缩放
- **布局结构**：
  ```
  整体水平布局
  ├── 左侧面板（25%宽度）
  │   └── 分类列表（垂直可滚动）
  │       ├── 分类按钮1（正方形，显示分类首图缩略）
  │       ├── 分类按钮2
  │       └── ...
  ├── 右侧面板（75%宽度）
  │   └── 表情网格（九宫格布局，垂直可滚动）
  │       ├── 表情单元格1
  │       ├── 表情单元格2
  │       └── ...
  └── 底部面板（100%宽度）
      └── 搜索框（实时搜索，支持清除按钮）
  ```
- **交互细节**：
  - 分类按钮：正方形，显示分类第一张表情的缩略图，鼠标悬停显示分类名（ToolTip）
  - 表情单元格：固定大小正方形，等比例显示表情缩略图，空白部分留白
  - 点击反馈：点击单元格时高亮显示（边框+半透明覆盖层）
  - 滚动体验：平滑滚动，支持鼠标滚轮和拖动滚动条

### 3. 核心功能流程
- **呼出与隐藏**：
  1. 用户按下预设全局热键（如Ctrl+Shift+E）
  2. 程序窗口在屏幕右上角弹出显示
  3. 用户按下Esc键，窗口隐藏
  4. 隐藏后显示系统托盘图标，程序后台运行

- **表情使用流程**：
  1. 点击左侧分类按钮，右侧显示该分类表情
  2. 在九宫格中找到目标表情
  3. 双击表情单元格
  4. 表情图片被复制到系统剪贴板
  5. 用户可在任何支持图片粘贴的应用中粘贴使用

- **搜索流程**：
  1. 在底部搜索框输入关键词
  2. 实时在所有分类的所有表情文件名中搜索
  3. 结果显示在右侧网格中（全局展示，不分分类）
  4. 清空搜索框恢复当前分类显示

### 4. 懒加载与性能优化
- **三级加载策略**：
  1. **元数据级**：程序启动时加载所有文件的路径、名称、大小等信息
  2. **缩略图级**：可视区域内的表情动态生成缩略图
  3. **完整图级**：双击使用时加载完整图片到剪贴板

- **智能缓存机制**：
  - 缩略图缓存：最近使用的缩略图保留在内存中
  - 文件信息缓存：避免重复扫描文件系统
  - 缓存自动清理：基于LRU算法管理缓存大小

- **滚动优化**：
  - 虚拟化渲染：只创建可视区域内的单元格控件
  - 预加载机制：提前加载即将进入视图的内容
  - 滚动节流：快速滚动时降低渲染频率

### 5. 系统集成
- **全局热键**：使用keyboard库实现跨进程热键监听
- **系统托盘**：
  - 隐藏窗口后在托盘显示图标
  - 右键菜单：显示窗口、重新加载、设置、退出
  - 双击托盘图标快速呼出窗口
- **剪贴板集成**：支持标准图像剪贴板格式，兼容大多数应用

## 三、配置与日志系统

### 1. JSON配置文件
- **存储位置**：用户目录下的`.sticker_manager/config.json`
- **配置内容**：
  ```json
  {
    "library_path": "C:/Users/Username/Pictures/Stickers",
    "hotkey": "ctrl+shift+e",
    "window_position": [1500, 50],
    "window_size": [400, 600],
    "ui": {
      "category_button_size": 72,
      "grid_cell_size": 100,
      "grid_columns": 3,
      "grid_rows": 3
    },
    "behavior": {
      "copy_on_double_click": true,
      "highlight_on_click": true,
      "search_delay_ms": 300
    },
    "performance": {
      "thumbnail_cache_size": 200,
      "lazy_load_enabled": true
    }
  }
  ```
- **配置管理**：
  - 首次运行生成默认配置
  - 提供GUI配置界面（后续版本）
  - 配置热重载支持

### 2. 日志系统
- **日志级别**：DEBUG、INFO、WARNING、ERROR、CRITICAL
- **输出目标**：文件日志（滚动归档）和控制台输出
- **关键日志点**：
  - 程序启动/退出
  - 热键注册状态
  - 表情库加载统计
  - 文件加载错误
  - 用户操作（分类切换、搜索、复制）
- **日志格式**：`[时间] [级别] [模块] - 消息`

## 四、技术架构

### 1. 模块分层设计
```
应用层
├── 主窗口控制器
├── 用户输入处理器
└── 系统托盘管理器

业务层
├── 数据管理器（表情库操作）
├── 搜索引擎（文件名检索）
└── 剪贴板服务

基础设施层
├── 配置管理器（JSON读写）
├── 日志记录器
├── 热键监听器（keyboard库）
└── 图像处理器（PIL/PySide6）

UI组件层
├── 分类按钮组件
├── 表情网格组件
├── 表情单元格组件
└── 自定义滚动区域
```

### 2. 关键算法
- **图片格式检测**：扩展名+文件头双重验证
- **缩略图生成**：保持宽高比，自适应填充正方形
- **搜索算法**：子字符串匹配，不区分大小写
- **缓存淘汰**：LRU（最近最少使用）算法
